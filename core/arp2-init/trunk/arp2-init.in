#!/bin/bash
#
# arp2-init: Start UAE/ARP2 in stand-alone mode
#
# Based on /etc/rc.sysinit from RedHat FC5.
#
# Notable missing features compared to FC5 startup:
# * No SE-Linux
# * No RAID/LVM
# * No quotas
# * No read-only root fs
# * No network profiles.
#
# Boot time analysis:
#
# Start until hwclock:		0.3 s
# hwclock			1.0 s (max)
# hwclock until udev		0.2 s
# udev				4.8 s (loading kernel modules)
# udev-stw			0.4 s (loading kernel modules)
# udev-stw until arp2-config	0.7 s (fsck, mounting, filesystem cleanup)
# X				4.6 s
#
# Total:			12.0 s
#
#
# /tmp/arp2-bootlevel settings:
#
# -1				halt
# 0				power off
# 1				normal reboot
# 2				kexec reboot (if possible)
# 3				restart virtual machine

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
sysconfdir=@sysconfdir@
datadir=@datadir@

#export PATH=/sbin:/bin:/usr/X11R6/bin:${bindir}
export PATH=/sbin:/bin:/usr/bin:${bindir}

# Import configuration
FONT=topaz8dbl.psf
KICKSTART=3.1
RESOLUTION=
DEPTH=24
ISSUE=issue-3.1
. ${sysconfdir}/arp2.conf

# Gimme a nice font!
setfont ${datadir}/fonts/${FONT}

CURSOR='\e[?81;240;145c'
SCREEN='\e[0m\e[44m\e[34m\e[4m'

# Turn on a brown/orange soft cursor, no blinking
echo -en "$CURSOR"

# White (grey+intensitivity) text on blue backround
echo -en "$SCREEN"

# Clear screen, goto 0,0
echo -en "\e[2J\e[0;0f"

# Make the prompt reset the colors
#export PS1="${CURSOR}${SCREEN}\s> "

cat ${sysconfdir}/${ISSUE}

echo 
echo -n "Press 'c' for config menu. Loading ..."

HOSTNAME=`/bin/hostname`
HOSTTYPE=`uname -m`
unamer=`uname -r`

if [ -f /etc/sysconfig/network ]; then
    . /etc/sysconfig/network
fi
if [ -z "$HOSTNAME" -o "$HOSTNAME" = "(none)" ]; then
    HOSTNAME=localhost
fi

if [ ! -e /proc/mounts ]; then 
	mount -n -t proc /proc /proc
	mount -n -t sysfs /sys /sys >/dev/null 2>&1
fi
if [ ! -d /proc/bus/usb ]; then
	modprobe usbcore >/dev/null 2>&1 && mount -n -t usbfs /proc/bus/usb /proc/bus/usb
else
	mount -n -t usbfs /proc/bus/usb /proc/bus/usb
fi

echo -n "."

. /etc/init.d/functions

# Set the system clock.
ARC=0
SRM=0
UTC=0

if [ -f /etc/sysconfig/clock ]; then
   . /etc/sysconfig/clock
fi

CLOCKDEF=""
CLOCKFLAGS="$CLOCKFLAGS --hctosys"

case "$UTC" in
    yes|true)	CLOCKFLAGS="$CLOCKFLAGS --utc"
		CLOCKDEF="$CLOCKDEF (utc)" ;;
    no|false)	CLOCKFLAGS="$CLOCKFLAGS --localtime"
		CLOCKDEF="$CLOCKDEF (localtime)" ;;
esac
case "$ARC" in
    yes|true)	CLOCKFLAGS="$CLOCKFLAGS --arc"
		CLOCKDEF="$CLOCKDEF (arc)" ;;
esac
case "$SRM" in
    yes|true)	CLOCKFLAGS="$CLOCKFLAGS --srm"
		CLOCKDEF="$CLOCKDEF (srm)" ;;
esac

/sbin/hwclock $CLOCKFLAGS

echo -n "."

# Fix console loglevel
if [ -n "$LOGLEVEL" ]; then
        /bin/dmesg -n $LOGLEVEL
fi

echo -n "."

# Only read this once.
cmdline=$(cat /proc/cmdline)

# Initialize hardware
if [ -f /proc/sys/kernel/modprobe ]; then
   if ! strstr "$cmdline" nomodules && [ -f /proc/modules ] ; then
       sysctl -w kernel.modprobe="/sbin/modprobe" >/dev/null 2>&1
   else
       # We used to set this to NULL, but that causes 'failed to exec' messages"
       sysctl -w kernel.modprobe="/bin/true" >/dev/null 2>&1
   fi
fi

echo -n "."

touch /dev/.in_sysinit >/dev/null 2>&1

killall nash-hotplug >/dev/null 2>&1
/sbin/start_udev >/dev/null

echo -n "."

# Load other user-defined modules
for file in /etc/sysconfig/modules/*.modules ; do
  [ -x $file ] && $file
  echo -n "."
done

mount -n /dev/pts >/dev/null 2>&1

# Configure kernel parameters
sysctl -e -p /etc/sysctl.conf >/dev/null 2>&1

# Set the hostname.
hostname ${HOSTNAME}

# Initialize ACPI bits
if [ -d /proc/acpi ]; then
    for module in /lib/modules/$unamer/kernel/drivers/acpi/* ; do
        module=${module##*/}
        module=${module%.ko}
        modprobe $module >/dev/null 2>&1
        echo -n "."
    done
fi

# Insert ATI/NVIDIA kernel modules if present
modprobe nvidia fglrx >/dev/null 2>&1

# TODO: Add RAID startup code here?

echo " Done."
echo

# Detect ATI/NVIDIA graphics card
DRIVER="*** WARNING: No supported"
grep -q "^fglrx .*Live" /proc/modules && DRIVER=ATI
grep -q "^nvidia .*Live" /proc/modules && DRIVER=NVIDIA

echo "${DRIVER} graphics card detected."
echo

if [ -f /fastboot ] || strstr "$cmdline" fastboot ; then
	fastboot=yes
fi

if [ -f /fsckoptions ]; then
	fsckoptions=`cat /fsckoptions`
fi

if [ -f /forcefsck ] || strstr "$cmdline" forcefsck ; then
	fsckoptions="-f $fsckoptions"
elif [ -f /.autofsck ]; then
	[ -f /etc/sysconfig/autofsck ] && . /etc/sysconfig/autofsck
	if [ "$AUTOFSCK_DEF_CHECK" = "yes" ]; then
		AUTOFSCK_OPT="$AUTOFSCK_OPT -f"
	fi
	fsckoptions="$AUTOFSCK_OPT $fsckoptions"
fi

fsckoptions="-V $fsckoptions"

if [ -z "$fastboot" ]; then
	echo "Checking filesystems"
	fsck -T -t noopts=_netdev -A -a $fsckoptions
	rc=$?
	
	if [ "$rc" -eq "0" ]; then
		echo
	elif [ "$rc" -eq "1" ]; then
		echo
	elif [ "$rc" -eq "2" -o "$rc" -eq "3" ]; then 
		echo $"Unmounting file systems"
		umount -a
		mount -n -o remount,ro /
		echo $"Automatic reboot in progress."
		reboot -f
        fi
	
        # A return of 4 or higher means there were serious problems.
	if [ $rc -gt 1 ]; then
		echo
		echo $"*** An error occurred during the file system check."
		echo $"*** Dropping you to a shell; the system will reboot"
		echo $"*** when you leave the shell."

		sulogin

		echo $"Unmounting file systems"
		umount -a
		mount -n -o remount,ro /
		echo $"Automatic reboot in progress."
		reboot -f
	fi
fi

{
# Unmount the initrd, if necessary
if LC_ALL=C fgrep -q /initrd /proc/mounts && ! LC_ALL=C fgrep -q /initrd/loopfs /proc/mounts ; then
   umount /initrd
   /sbin/blockdev --flushbufs /dev/ram0 >/dev/null 2>&1
fi

# Remount the root filesystem read-write.
mount -n -o remount,rw /

# Clear mtab
(> /etc/mtab) &> /dev/null

# Remove stale backups
rm -f /etc/mtab~ /etc/mtab~~

# Enter mounted filesystems into /etc/mtab
mount -f /
mount -f /proc >/dev/null 2>&1
mount -f /sys >/dev/null 2>&1
mount -f /dev/pts >/dev/null 2>&1
mount -f /proc/bus/usb >/dev/null 2>&1

# Mount all other filesystems (except for NFS and /proc, which is already
# mounted).
mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs -O no_netdev

# Initialize pseudo-random number generator
if [ -f "/var/lib/random-seed" ]; then
	cat /var/lib/random-seed > /dev/urandom
else
	touch /var/lib/random-seed
fi
chmod 600 /var/lib/random-seed
dd if=/dev/urandom of=/var/lib/random-seed count=1 bs=512 2>/dev/null

# Clean out /.
rm -f /fastboot /fsckoptions /forcefsck /.autofsck /halt /poweroff &> /dev/null

# Reset pam_console permissions
[ -x /sbin/pam_console_apply ] && /sbin/pam_console_apply -r

# Clean up utmp/wtmp
> /var/run/utmp
touch /var/log/wtmp
chgrp utmp /var/run/utmp /var/log/wtmp
chmod 0664 /var/run/utmp /var/log/wtmp

# Clean up various /tmp bits
rm -f /tmp/.X*-lock /tmp/.lock.* /tmp/.gdm_socket /tmp/.s.PGSQL.*
rm -rf /tmp/.X*-unix /tmp/.ICE-unix /tmp/.font-unix /tmp/hsperfdata_* \
       /tmp/kde-* /tmp/ksocket-* /tmp/mc-* /tmp/mcop-* /tmp/orbit-*  \
       /tmp/scrollkeeper-*  /tmp/ssh-* \
       /dev/.in_sysinit

# Make ICE directory
mkdir -m 1777 -p /tmp/.ICE-unix >/dev/null 2>&1
chown root:root /tmp/.ICE-unix

# Start up swapping.
swapon -a -e

# Set up binfmt_misc
/bin/mount -t binfmt_misc none /proc/sys/fs/binfmt_misc > /dev/null 2>&1

# Initialize the serial ports.
if [ -f /etc/rc.serial ]; then
	. /etc/rc.serial
fi

# If they asked for ide-scsi, load it
if strstr "$cmdline" ide-scsi ; then
	modprobe ide-cd >/dev/null 2>&1
	modprobe ide-scsi >/dev/null 2>&1
fi

# Boot time profiles. Yes, this should be somewhere else.
if [ -x /usr/sbin/system-config-network-cmd ]; then
  if strstr "$cmdline" netprofile= ; then
    for arg in $cmdline ; do
        if [ "${arg##netprofile=}" != "${arg}" ]; then
	    /usr/sbin/system-config-network-cmd --profile ${arg##netprofile=}
        fi
    done
  fi
fi

# Now that we have all of our basic modules loaded and the kernel going,
# let's dump the syslog ring somewhere so we can find it later
dmesg -s 131072 > /var/log/dmesg

kill -TERM `/sbin/pidof getkey` >/dev/null 2>&1
} &

/sbin/getkey c > /dev/null && config_me=yes
wait

if [ "x$config_me" == "xyes" ] || 
   [ ! -f ${sysconfdir}/arp2.conf ] ||
   [ ! -f ${sysconfdir}/arp2-xorg.keyboard ] || 
   [ ! -f ${sysconfdir}/arp2-xorg.monitor ] ||
   [ ! -f ${sysconfdir}/arp2-xorg.mouse ] ; then
  ${sbindir}/arp2-config
  . ${sysconfdir}/arp2.conf
fi

while true; do
    # Default is fast reboot, if possible
    echo -1 > /tmp/arp2-bootlevel
    echo -n "System ready. Starting virtual machine ..."
    export XORGCONFIG=/tmp/arp2-xorg.conf
    m4 -DDEPTH="${DEPTH}" -DRESOLUTION="${RESOLUTION}" -DDRIVER="${DRIVER}" \
	-I ${sysconfdir} \
	< ${sysconfdir}/arp2-xorg.conf.m4 > ${XORGCONFIG}
    xinit 2> /dev/null ${sbindir}/arp2-xinit
    chvt 1
    bootlevel=$(cat /tmp/arp2-bootlevel 2> /dev/null)
    [ "$bootlevel" -ge "-1" -a "$bootlevel" -le "3" 2> /dev/null ] || bootlevel=-1

    if [ $bootlevel -lt 0 ]; then
	echo " Error!"
    else
	echo " Done."
    fi
    if [ $bootlevel -lt 3 ]; then
	break;
    fi;
done
rm -f /tmp/arp2-bootlevel

if [ $bootlevel -eq -1 ]; then
    echo "*** There was a problem starting X or the virtual machine."
    echo "*** Please check /var/log/Xorg.0.log for more information."
    echo "*** Dropping you to a shell; the system will reboot"
    echo "*** when you leave the shell."
    bootlevel=1
    sulogin
else
    # Drop into a shell if requested
    if strstr "$cmdline" shell ; then
	sulogin
    fi
fi


# Save random seed
touch /var/lib/random-seed
chmod 600 /var/lib/random-seed
dd if=/dev/urandom of=/var/lib/random-seed count=1 bs=512 2>/dev/null

echo -n "Unmounting filesystems ..."
swapoff -a
umount -a
mount -n -o remount,ro /
echo " Done."

case "$bootlevel" in
    -1)
	echo -n "Halting ... "
	halt -f -i -d
	reboot -f -i -d # I have no idea what to execute here, really ...
	;;
    0)
	echo -n "Shutting down ... "
	halt -f -i -d -p
	;;
    2)
	if [ -f /sbin/kexec ]; then
	    echo -n "Soft-rebooting ... "
	    /sbin/kexec -l --initrd=/boot/initrd-${unamer}.img --command-line="$(cat /proc/cmdline)" /boot/vmlinuz-${unamer} >& /dev/null
	    /sbin/kexec -e >& /dev/null
	fi
	;;
esac

# Reboot normally if we get here
echo -n "Rebooting ... "
reboot -f -i -d
