#!/bin/bash
#
# arp2-config: Simple configuration tool
#

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
sysconfdir=@sysconfdir@
EDITOR=@ED@

export PATH=/sbin:/bin:/usr/bin:${bindir}

copy_prefs() {
  cp ${sysconfdir}/${1}.default ${sysconfdir}/${1}
  chmod 444 ${sysconfdir}/${1}.default
  chmod 644 ${sysconfdir}/${1}
}

edit_prefs() {
  chmod 444 ${sysconfdir}/${1}.default
  chmod 644 ${sysconfdir}/${1}
  ${EDITOR} ${sysconfdir}/${1}
}

for file in arp2.conf arp2-xorg.keyboard arp2-xorg.monitor arp2-xorg.mouse; do
  test -f ${sysconfdir}/${file} || copy_prefs ${file}
done

# Import current configuration
. ${sysconfdir}/arp2.conf

while [ "${REPLY}" != "q" ]; do

    case "${REPLY}" in
	"D")
	    copy_prefs arp2.conf
	    copy_prefs arp2-xorg.monitor
	    copy_prefs arp2-xorg.keyboard
	    copy_prefs arp2-xorg.mouse
	    . ${sysconfdir}/arp2.conf
	    ;;
	"dd")
	    copy_prefs arp2-xorg.monitor
	    ;;
	"dk")
	    copy_prefs arp2-xorg.keyboard
	    ;;
	"dm")
	    copy_prefs arp2-xorg.mouse
	    ;;
	"ed")
	    edit_prefs arp2-xorg.monitor
	    ;;
	"ek")
	    edit_prefs arp2-xorg.keyboard
	    ;;
	"em")
	    edit_prefs arp2-xorg.mouse
	    ;;
	"ra") 
	    RESOLUTION=
	    ;;
	"d16") 
	    DEPTH=16
	    ;;
	"d24") 
	    DEPTH=24
	    ;;
	1.0|1.1|1.2|1.2|1.3|2.0|3.0|3.1)
	    KICKSTART=${REPLY}
	    ;;
	*)
	    echo ${REPLY} | egrep -q '^[0-9]{3,}x[0-9]{3,}' && RESOLUTION=${REPLY}
	    ;;
    esac

    # Clear screen, goto 0,0
    echo -en '\e[2J\e[0;0f'

    echo "Current configuration:"
#   echo "Font:            ${FONT}"
    echo "Resolution:      ${RESOLUTION:-Probed}"
    echo "Depth:           ${DEPTH:-24}"
    echo "Kickstart:       ${KICKSTART}"
    echo
    echo "Display Depth        Resolution           Kickstart version"
    echo "*******************  *******************  *******************"
    echo "d16) HiColor         ra)      Auto        1.0)  Kickstart 1.0"
    echo "d24) TrueColor       NNNxNNN) Custom      1.1)  Kickstart 1.1"
    echo "                                          1.2)  Kickstart 1.2"
    echo "Edit                 Reset to default     1.3)  Kickstart 1.3"
    echo "*******************  *******************  2.0)  Kickstart 2.0"
    echo "ed) Display          dd) Display          3.0)  Kickstart 3.0"
    echo "ek) Keyboard         dk) Keyboard         3.1)  Kickstart 3.1"
    echo "em) Mouse            dm) Mouse            "
    echo 
    echo "D) Restore everyting to default"
    echo "q) Save and quit"
    echo
    echo -n "1> "
    read
done

# Write configuration
cat > ${sysconfdir}/arp2.conf <<EOF
FONT=${FONT:-topaz8dbl.psf}
KICKSTART=${KICKSTART}
RESOLUTION=${RESOLUTION}
DEPTH=${DEPTH:-24}

ISSUE=issue-${KICKSTART}
EOF
